@inherits MudComponentBase

@inject ILanguageManagementService languageManagementService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudTable T="Language" Items="Languages" Loading="Loading"
          Height="100%" Class="@Class" Style="@($"height: 100%; display: grid; grid-template-rows: min-content 1fr; {Style}")" 
          FixedHeader="true" FixedFooter="true" Outlined="true" Hover="true" Elevation="0">

    <ToolBarContent>
        <MudText Class="mr-2" Typo="Typo.subtitle1">Languages</MudText>
        <MudSpacer />
        <MudIconButton Title="Refresh" Variant="Variant.Filled" Color="Color.Default" DisableElevation="true" 
                       Icon="@Icons.Material.Filled.Refresh" OnClick="Load" />
        <MudIconButton Title="Add new language" Variant="Variant.Filled" Color="Color.Primary" DisableElevation="true" 
                       Icon="@Icons.Material.Filled.Add" OnClick="ShowCreateLanguageDialog" />
    </ToolBarContent>

    <ColGroup>
        <col />
        <col />
        <col />
        <col />
    </ColGroup>

    <HeaderContent>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<Language, object>(x => x.Name)">Name</MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<Language, object>(x => x.Key)">Key</MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<Language, object>(x => x.IsPublic)">Public</MudTableSortLabel>
        </MudTh>
        <MudTh>
            Actions
        </MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Key">@context.Key</MudTd>
        <MudTd DataLabel="Public">
            <MudSwitch T="bool" Checked="@context.IsPublic" CheckedChanged="async (bool value) => await TogglePublic(context)" 
                       Color="Color.Success" />
        </MudTd>
        <MudTd DataLabel="Actions">
            <MudIconButton Title="Delete language" Variant="Variant.Filled" Color="Color.Error" DisableElevation="true" 
                           Icon="@Icons.Material.Filled.Delete" OnClick="async () => await DeleteLanguage(context)" />
        </MudTd>
    </RowTemplate>

    <PagerContent>
        <MudTablePager />
    </PagerContent>

</MudTable>

<MudDialog @bind-IsVisible="_showCreateDialog">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Language" Class="mr-3 mb-n1" />
            Create New Language
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_newLanguageName" Label="Name" Required="true" 
                      Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" />
        <MudTextField @bind-Value="_newLanguageKey" Label="Key" Required="true" 
                      Variant="Variant.Outlined" Margin="Margin.Dense" 
                      HelperText="Language identifier (e.g., 'en', 'pl', 'es')" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CancelCreateLanguage">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="CreateLanguage">Create</MudButton>
    </DialogActions>
</MudDialog>

<MudOverlay Visible="_isLoading" DarkBackground="true" Absolute="false">
    <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
</MudOverlay>

@code {
    [CascadingParameter] public LayoutState? LayoutState { get; set; }

    private List<Language>? _languages;
    private List<Language> Languages => _languages ?? new();
    private bool Loading => _languages is null;

    private bool _isLoading = false;
    private bool _showCreateDialog = false;
    private string _newLanguageName = string.Empty;
    private string _newLanguageKey = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        _languages = null;
        try
        {
            _languages = await languageManagementService.GetAllLanguagesAsync();
        }
        catch
        {
            Snackbar.Add("Failed to load languages", Severity.Error);
            _languages = new List<Language>();
        }
    }

    private void ShowCreateLanguageDialog()
    {
        _newLanguageName = string.Empty;
        _newLanguageKey = string.Empty;
        _showCreateDialog = true;
    }

    private void CancelCreateLanguage()
    {
        _showCreateDialog = false;
    }

    private async Task CreateLanguage()
    {
        if (string.IsNullOrWhiteSpace(_newLanguageName))
        {
            Snackbar.Add("Language name is required", Severity.Error);
            return;
        }

        if (string.IsNullOrWhiteSpace(_newLanguageKey))
        {
            Snackbar.Add("Language key is required", Severity.Error);
            return;
        }

        _showCreateDialog = false;
        _isLoading = true;

        try
        {
            var request = new CreateLanguageRequest
            {
                Name = _newLanguageName,
                Key = _newLanguageKey.ToLower().Trim(),
                IsPublic = false
            };

            await languageManagementService.CreateLanguageAsync(request);
            Snackbar.Add($"Language '{_newLanguageName}' created successfully", Severity.Success);
            await Load();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to create language: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task TogglePublic(Language language)
    {
        _isLoading = true;
        try
        {
            if (language.IsPublic)
            {
                await languageManagementService.HideLanguageAsync(language.Key);
                Snackbar.Add($"Language '{language.Name}' is now private", Severity.Success);
            }
            else
            {
                await languageManagementService.PublishLanguageAsync(language.Key);
                Snackbar.Add($"Language '{language.Name}' is now public", Severity.Success);
            }
            await Load();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update language: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task DeleteLanguage(Language language)
    {
        if (!await DialogService.ShowConfirmationDialog(
            "Delete language", 
            "delete", 
            "language", 
            $"{language.Name} ({language.Key})", 
            true))
            return;

        _isLoading = true;
        try
        {
            await languageManagementService.DeleteLanguageAsync(language.Key);
            Snackbar.Add($"Language '{language.Name}' deleted successfully", Severity.Success);
            await Load();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to delete language: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}