@inherits DialogAutoFullscreen
@inject IWorkspaceService WorkspaceService
@inject IStorageService StorageService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ITranslationsService t

<MudDialog>
	<DialogContent>
		@if (!Loading)
		{
			<MudStack Spacing="0" Style="height: calc(100vh - 200px)" Class="flex-grow-1">
				<FileManager Class="" Style="height: calc(100%)" Outlined="true" Elevation="0"
					             ChooseFolderMode="true" InitialFolderId="_selectedWorkspace!.RootFolderId"
								 OnFolderLoaded="OnFolderChanged" />
			</MudStack>
		}
	</DialogContent>
	
	<DialogActions>
		<MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="Cancel">@t.T("selectFolderDialog", "cancel")</MudButton>
		<MudButton Variant="Variant.Filled" Color="Color.Info" Disabled="!CanSubmit" OnClick="Submit">@SelectButtonText</MudButton>
	</DialogActions>
</MudDialog>


	@code {
	private Workspace? _selectedWorkspace;
	[Parameter]
	public long? InitialWorkspaceId { get; set; } = null;

	HashSet<long> _excludedFolderIds = null!;
	[Parameter]
	public IEnumerable<long>? ExcludedIds { get; set; }

	HashSet<long> _excludedWithChildrenFolderIds = null!;
	[Parameter]
	public IEnumerable<long>? ExcludedWithChildrenIds { get; set; }

	[Parameter]
	public string SelectButtonText { get; set; } = "Select";

	private bool _canChoose = false;

	bool Loading => _selectedWorkspace is null;

	private FolderItem? _currentFolder = null;




	protected override void OnInitialized()
	{
		Dialog.Options.FullWidth = true;
		Dialog.Options.MaxWidth = MaxWidth.Large;
		Dialog.SetOptions(Dialog.Options);
	}

	protected override async Task OnInitializedAsync()
	{
		// Use default workspace (ID -1) when no initial workspace specified
		var workspaceId = InitialWorkspaceId ?? -1;
		_selectedWorkspace = await WorkspaceService.GetWorkspaceAsync(workspaceId);

		if (_selectedWorkspace is null)
			Cancel();

		_excludedFolderIds = ExcludedIds?.ToHashSet() ?? new HashSet<long>();
		_excludedWithChildrenFolderIds = ExcludedWithChildrenIds?.ToHashSet() ?? new HashSet<long>();
	}

	private void OnFolderChanged(FileManager.FolderSelectedEventArgs args)
	{
		var folder = args.Folder;
		_currentFolder = folder;

		_canChoose = folder.CanWrite
						&& !_excludedFolderIds.Contains(folder.Id)
						&& !_excludedWithChildrenFolderIds.Contains(folder.Id)
						&& !args.Breadcrumbs.Any(x => _excludedWithChildrenFolderIds.Contains(x.Id));
	}


	private bool CanSubmit => _currentFolder is not null && _canChoose;
	private void Submit()
	{
		if (!CanSubmit) return;
		Dialog.Close(DialogResult.Ok(_currentFolder));
	}

	void Cancel()
	{
		Dialog.Cancel();
	}

}