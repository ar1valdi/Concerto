@page "/joinstream"
@using Concerto.Client.Services;
@using Concerto.Shared.Extensions;
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication;
@using Microsoft.AspNetCore.Authorization;
@attribute [Authorize(Policy = AuthorizationPolicies.IsAuthenticated.Name)]
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IAccessTokenProvider _accessTokenProvider
@implements IAsyncDisposable

<PageTitle>Join Stream</PageTitle>

<style>
    .container {
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .join-form {
        background: #f5f5f5;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-width: 500px;
        width: 100%;
    }

    .stream-preview {
        width: 100%;
        max-width: 1280px;
        height: 720px;
        background-color: black;
        border-radius: 8px;
        margin-top: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        position: relative;
    }

    .stream-preview video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .playback-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 12px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        text-align: center;
        padding: 20px;
    }

    .status-message {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
    }

    .status-connecting {
        background-color: #e3f2fd;
        color: #1976d2;
    }

    .status-error {
        background-color: #ffebee;
        color: #c62828;
    }

    .status-connected {
        background-color: #e8f5e8;
        color: #2e7d32;
    }
</style>

<div class="container">
    @if (!IsConnected)
    {
        <div class="join-form">
            <MudText Typo="Typo.h4" Class="mb-4">Join Live Stream</MudText>
            
            <MudTextField @bind-Value="StreamIdInput" 
                         Label="Stream ID" 
                         Placeholder="Enter the stream ID shared by the host"
                         Variant="Variant.Filled"
                         Class="mb-4"
                         Disabled="@IsConnecting" />
            
            <MudButton Color="Color.Primary" 
                      Variant="Variant.Filled" 
                      FullWidth="true"
                      OnClick="JoinStreamAsync"
                      Disabled="@(string.IsNullOrWhiteSpace(StreamIdInput) || IsConnecting)">
                @if (IsConnecting)
                {
                    <MudProgressCircular Size="Size.Small" Class="mr-2" />
                    <span>Connecting...</span>
                }
                else
                {
                    <span>Join Stream</span>
                }
            </MudButton>

            @if (!string.IsNullOrEmpty(StatusMessage))
            {
                <div class="status-message @GetStatusClass()">
                    @StatusMessage
                </div>
            }
        </div>
    }
    else
    {
        <div style="width: 100%; text-align: center; margin-bottom: 20px;">
            <MudText Typo="Typo.h5" Style="color: #2e7d32;">✅ Connected to Stream: @StreamIdInput</MudText>
            <MudButton Color="Color.Error" 
                      Variant="Variant.Filled" 
                      OnClick="LeaveStream"
                      Class="mt-2">
                Leave Stream
            </MudButton>
        </div>
    }

    <div class="stream-preview">
        <video id="streamVideo" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: contain; display: @(IsConnected ? "block" : "none");"></video>
        @if (RequiresPlaybackPrompt)
        {
            <div class="playback-overlay">
                <MudText Typo="Typo.h6">Autoplay is blocked by your browser.</MudText>
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="ResumePlaybackAsync">
                    Start Playback
                </MudButton>
            </div>
        }
        @if (!IsConnected)
        {
            @if (IsConnecting)
            {
                <MudText Typo="Typo.h6" Style="color: white;">Connecting to stream...</MudText>
            }
            else
            {
                <MudText Typo="Typo.h6" Style="color: white;">Enter a stream ID above to join</MudText>
            }
        }
    </div>
</div>

@code {
    [CascadingParameter] LayoutState LayoutState { get; set; } = LayoutState.Default;

    private string StreamIdInput { get; set; } = string.Empty;
    private bool IsConnecting { get; set; } = false;
    private bool IsConnected { get; set; } = false;
    private bool RequiresPlaybackPrompt { get; set; }
    private string StatusMessage { get; set; } = string.Empty;

    private DotNetObjectReference<JoinStreamPage> _dotNetObjectReference = null!;
    private IJSObjectReference? _streamViewer;
    private (string streamId, string hostConnectionId)? _pendingStreamJoined;

    protected override void OnInitialized()
    {
        _dotNetObjectReference = DotNetObjectReference.Create(this);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var uri = new Uri(Navigation.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var streamIdFromUrl = query["id"];
            
            if (!string.IsNullOrEmpty(streamIdFromUrl))
            {
                StreamIdInput = streamIdFromUrl;
                StateHasChanged();
                
                // Auto-join if stream ID provided in URL
                await Task.Delay(500);
                await JoinStreamAsync();
            }
        }
    }

    private async Task JoinStreamAsync()
    {
        if (string.IsNullOrWhiteSpace(StreamIdInput) || IsConnecting) return;

        try
        {
            IsConnecting = true;
            StatusMessage = "Connecting to stream...";
            RequiresPlaybackPrompt = false;
            StateHasChanged();

            // Initialize viewer FIRST, before connecting to SignalR
            _streamViewer = await JS.InvokeAsync<IJSObjectReference>("initializeStreamViewer", "streamVideo", StreamIdInput, _dotNetObjectReference);

            if (_pendingStreamJoined is not null)
            {
                var pending = _pendingStreamJoined.Value;
                _pendingStreamJoined = null;
                await _streamViewer.InvokeVoidAsync("handleStreamJoined", pending.streamId, pending.hostConnectionId);
            }
            
            Console.WriteLine("Stream viewer initialized and connected to SignalR");
        }
        catch (Exception ex)
        {
            StatusMessage = $"Failed to connect: {ex.Message}";
            IsConnecting = false;
            StateHasChanged();
        }
    }

    private async Task LeaveStream()
    {
        if (_streamViewer is not null)
        {
            await _streamViewer.InvokeVoidAsync("dispose");
            _streamViewer = null;
        }
        _pendingStreamJoined = null;
        
        IsConnected = false;
        IsConnecting = false;
        RequiresPlaybackPrompt = false;
        StatusMessage = string.Empty;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task<string> GetAccessToken()
    {
        try
        {
            Console.WriteLine("JoinStreamPage: Requesting access token...");
            var tokenResult = await _accessTokenProvider.RequestAccessToken();
            var hasToken = tokenResult.TryGetToken(out var token);
            Console.WriteLine($"JoinStreamPage: Token result - HasToken: {hasToken}, TokenValue: {(hasToken ? "Present" : "None")}");
            return hasToken ? token.Value : string.Empty;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JoinStreamPage: Error getting access token: {ex.Message}");
            return string.Empty;
        }
    }

    [JSInvokable]
    public void StreamConnected()
    {
        Console.WriteLine("JoinStreamPage: Stream successfully connected!");
        IsConnected = true;
        IsConnecting = false;
        StatusMessage = "Successfully connected to stream!";
        StateHasChanged();
    }

    [JSInvokable]
    public void StreamAutoplayBlocked()
    {
        if (!RequiresPlaybackPrompt)
        {
            RequiresPlaybackPrompt = true;
            StatusMessage = "Autoplay blocked. Click Start Playback to continue.";
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void StreamError(string message)
    {
        IsConnected = false;
        IsConnecting = false;
        StatusMessage = $"Connection failed: {message}";
        StateHasChanged();
    }

    [JSInvokable]
    public void StreamEnded(string streamId)
    {
        IsConnected = false;
        IsConnecting = false;
        StatusMessage = "Stream has ended";
        StateHasChanged();
    }

    [JSInvokable]
    public async Task StreamJoined(string streamId, string hostConnectionId)
    {
        if (_streamViewer is not null)
        {
            await _streamViewer.InvokeVoidAsync("handleStreamJoined", streamId, hostConnectionId);
        }
        else
        {
            _pendingStreamJoined = (streamId, hostConnectionId);
        }
    }

    [JSInvokable]
    public async Task ReceiveOffer(string streamId, string fromConnectionId, string offer)
    {
        if (_streamViewer is not null)
        {
            await _streamViewer.InvokeVoidAsync("handleOffer", streamId, fromConnectionId, offer);
        }
    }

    [JSInvokable]
    public async Task ReceiveAnswer(string streamId, string fromConnectionId, string answer)
    {
        if (_streamViewer is not null)
        {
            await _streamViewer.InvokeVoidAsync("handleAnswer", streamId, fromConnectionId, answer);
        }
    }

    [JSInvokable]
    public async Task ReceiveIceCandidate(string streamId, string fromConnectionId, string candidate)
    {
        if (_streamViewer is not null)
        {
            await _streamViewer.InvokeVoidAsync("handleIceCandidate", streamId, fromConnectionId, candidate);
        }
    }

    private string GetStatusClass()
    {
        if (IsConnecting) return "status-connecting";
        if (IsConnected) return "status-connected";
        if (!string.IsNullOrEmpty(StatusMessage) && StatusMessage.Contains("Failed")) return "status-error";
        return "";
    }

    private async Task ResumePlaybackAsync()
    {
        try
        {
            var resumed = await JS.InvokeAsync<bool>("resumeStreamPlayback", "streamVideo", false);
            if (resumed)
            {
                RequiresPlaybackPrompt = false;
                StatusMessage = "Playback started.";
            }
            else
            {
                StatusMessage = "Browser still blocking autoplay. Please try again.";
            }
        }
        catch (Exception ex)
        {
            StatusMessage = $"Unable to start playback: {ex.Message}";
        }

        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (_streamViewer is not null)
        {
            await _streamViewer.InvokeVoidAsync("dispose");
        }
        _pendingStreamJoined = null;
        _dotNetObjectReference?.Dispose();
    }
}
