@attribute [Authorize]
@page "/courses/{SelectedCourseId:long}"
@using Concerto.Client.Components.Dialogs
@using Concerto.Client.Components
@using Concerto.Client.Components.Input
@using Concerto.Client.Components.Lists
@using Concerto.Client.Services
@using Concerto.Shared.Extensions

@using Concerto.Shared.Models.Dto;
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

@inject NavigationManager NavigationManager
@inject HttpClient Http;
@inject ICourseService CourseService;
@inject IBreadcrumbsService BreadcrumbsService;
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Course</PageTitle>

@if (Loading)
{
	<LoadingIndicator Color="Color.Primary" Size="Size.Large" />
}
else
{
	<MudTabs Outlined="true" Position="Position.Top" Rounded="true" Border="true"
		 ApplyEffectsToContainer="true" Class="" PanelClass="panel-height-maximum" Style="height: calc(100%);">

		<MudTabPanel Text="Content">
			<FileManager Class="flex-grow-1" Height="100%" Style="height: calc(100% - 40px); min-width: 70%" InitialFolderId="SelectedCourse.RootFolderId" />
		</MudTabPanel>

		<MudTabPanel Text="Sessions">
			<CourseSessionList Style="width: 100%; height: 100%; flex: 1 1 auto;" Class="flex-shrink-1 pa-2" CourseId="SelectedCourseId" OnSessionSelected="OnSessionSelected" />
		</MudTabPanel>

		<MudTabPanel Text="Forum">
			<ChatBox ConversationName="Course conversation" SelectedConversationId="SelectedCourse.ConversationId" />
		</MudTabPanel>

		@if (SelectedCourse!.CanManage)
		{
			<MudTabPanel Text="Settings">
				<CourseSettingsView CourseId="SelectedCourseId" OnCourseDeleted="OnCourseDeleted" />
			</MudTabPanel>
		}

	</MudTabs>
}


@code {
	[Parameter]
	public long SelectedCourseId { get; set; }
	private Course? SelectedCourse { get; set; }

	private bool Loading => SelectedCourse is null;

	protected override async Task OnParametersSetAsync()
	{
		SelectedCourse = await CourseService.GetCourse(SelectedCourseId);
		if (SelectedCourse == null) NavigationManager.NavigateTo("courses");
		BreadcrumbsService.Set(
			Icons.Material.Filled.MenuBook,
			SelectedCourse?.Name ?? string.Empty,
			new BreadcrumbItem("Courses", "courses"),
			new BreadcrumbItem(SelectedCourse?.Name, null, true)
		);
	}
	
	private void OnSessionSelected(long sessionId) {
		NavigationManager.NavigateTo($"courses/{SelectedCourseId}/sessions/{sessionId}");
	}

	private void OnCourseDeleted()
	{
		NavigationManager.NavigateTo($"courses");
	}

}