@using Concerto.Client.Components.Layout;
@using Concerto.Client.Services
@using Concerto.Shared.Models.Dto
@using Concerto.Client.Components.Lists
@inject ICourseService CourseService
@inject ISnackbar Snackbar
@inject HttpClient Http
@inject IStorageService StorageService
@inject IDialogService DialogService
@inherits DialogAutoFullscreen

<MudDialog>
	<DialogContent>
		@if (!Loading)
		{
			<MudStack Spacing="0" Style="height: calc(100vh - 134px)" Class="flex-grow-1">
				
				<MudStack Row="true" AlignItems="AlignItems.Center">
					<MudCheckBox @bind-Checked="ToAnotherCourse">To another course</MudCheckBox>
					@if (ToAnotherCourse)
					{
						<MudIcon Icon="@Icons.Material.Filled.ArrowRight"/>
						<MudText>@_selectedCourse?.Name</MudText>
						<MudButton Color="Color.Info" OnClick="ChooseCourse">Change</MudButton>
					}
				</MudStack>

				<FileManager Class="" Style="height: calc(100% - 48px)" Outlined="true" Elevation="0"
					             ChooseFolderMode="true" InitialFolderId="_selectedCourse!.RootFolderId"
								 OnFolderLoaded="OnFolderChanged" />
			</MudStack>
		}
	</DialogContent>
	
	<DialogActions>
		<MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="Cancel">Cancel</MudButton>
		<MudButton Variant="Variant.Filled" Color="Color.Info" Disabled="!_canChoose" OnClick="Submit">@(Copy ? "Copy here" : "Move here")</MudButton>
	</DialogActions>
</MudDialog>


@code {

	[Parameter]
	public IReadOnlyCollection<FolderContentItem>? Items { get; set; }

	HashSet<long> ExcludedFromChoose = null!;

	[Parameter]
	public long FromFolderId { get; set; }

	[Parameter]
	public long InitialCourseId { get; set; }

	[Parameter]
	public bool Copy { get; set; }

	private bool _canChoose = false;
	private long _destinationFolderId;

	private bool _toAnotherCourse;

	private bool ToAnotherCourse
	{
		get => _toAnotherCourse;
		set
		{
			if (value == false)
			{
				_toAnotherCourse = value;
				_selectedCourse = _initialCourse;
				_canChoose = false;
			}
			else
			{
				ChooseCourse().AndForget();
			}
		}
	}


	private Course _initialCourse = null!;
	private Course? _selectedCourse;


	bool Loading => Items is null || _selectedCourse is null || (_moveRequest is null && _copyRequest is null);
	string ItemsString => Items is null ? string.Empty : string.Join(", ", Items.Select(i => i.Name));
	string ActionString => Copy ? "Copying" : "Moving";

	// Form
	MoveFolderItemsRequest _moveRequest = null!;
	CopyFolderItemsRequest _copyRequest = null!;

	protected override void OnInitialized()
	{
		Dialog.Options.FullWidth = true;
		Dialog.Options.MaxWidth = MaxWidth.Large;
		Dialog.SetOptions(Dialog.Options);
	}

	protected override async Task OnInitializedAsync()
	{
		if (Items is null) return;
		_initialCourse = await CourseService.GetCourseAsync(InitialCourseId);
		_selectedCourse = _initialCourse;

		var folderIds = Items.Where(item => item is FolderItem).Select(folder => folder.Id);
		var fileIds = Items.Where(item => item is FileItem).Select(file => file.Id);

		ExcludedFromChoose = folderIds.ToHashSet();

		_copyRequest = new CopyFolderItemsRequest
		{
			FolderIds = folderIds,
			FileIds = fileIds,
			DestinationFolderId = FromFolderId
		};

		_moveRequest = new MoveFolderItemsRequest
		{
			FolderIds = folderIds,
			FileIds = fileIds,
			DestinationFolderId = FromFolderId
		};
	}

	private async Task ChooseCourse()
	{
		var parameters = new DialogParameters { ["WithoutCourseIds"] = new List<long> { InitialCourseId } };
		var name = "Select course";
		var result = await DialogService.Show<SelectCourseDialog>(name, parameters).Result;
		if (result.Canceled) return;
		var courseId = result.Data as long?;
		if (courseId is null) return;
		_toAnotherCourse = true;
		_selectedCourse = await CourseService.GetCourseAsync(courseId.Value);
		_copyRequest.DestinationFolderId = _selectedCourse.RootFolderId;
		_moveRequest.DestinationFolderId = _selectedCourse.RootFolderId;
		StateHasChanged();
	}

	private void OnFolderChanged(FileManager.FolderSelectedEventArgs args)
	{
		var folder = args.Folder;
		_destinationFolderId = folder.Id;
		_canChoose = folder.CanWrite
					 && FromFolderId != folder.Id
					 && !ExcludedFromChoose.Contains(folder.Id)
					 && !args.Breadcrumbs.Any(x => ExcludedFromChoose.Contains(x.Id));
	}

	private async Task Submit()
	{
		_copyRequest.DestinationFolderId = _destinationFolderId;
		_moveRequest.DestinationFolderId = _destinationFolderId;
		try
		{
			if (Copy)
			{
				await StorageService.CopyFolderItemsAsync(_copyRequest);
			}
			else
			{
				await StorageService.MoveFolderItemsAsync(_moveRequest);
			}
			Snackbar.Add($"{(Copy ? "Copied" : "Moved")} succesfully", Severity.Success);
		}
		catch
		{
			Snackbar.Add($"Failed to {(Copy ? "copy" : "move")} items", Severity.Error);
		}
		Dialog.Close();
	}

	void Cancel()
	{
		Dialog.Cancel();
	}

}