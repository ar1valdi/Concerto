@attribute [Authorize]
@page "/courses/{CourseId:long}/sessions/{SelectedSessionId:long}"
@using Concerto.Shared.Client.Services
@using Concerto.Shared.Models.Dto
@using Microsoft.AspNetCore.Authorization
@using Concerto.Shared.Client.Components.Lists

@inject NavigationManager NavigationManager
@inject IBreadcrumbsService BreadcrumbsService;
@inject ISessionService SessionService;
<PageTitle>@($"Session - {SelectedSession?.Name}")</PageTitle>


@if (Loading)
{
	<LoadingIndicator Color="Color.Primary" Size="Size.Large"/>
}
else
{
	<MudTabs Outlined="true" Position="Position.Top"
	         ApplyEffectsToContainer="true" Class="" PanelClass="panel-height-maximum" Style="height: calc(100%);"
	         KeepPanelsAlive="true">

		<MudTabPanel Text="Meeting">
			<Meeting MeetingName="@SelectedSession?.Name" Guid="@SelectedSession?.MeetingGuid"/>
		</MudTabPanel>

		<MudTabPanel Text="Course content">
			<FileManager InitialFolderId="SelectedSession!.CourseRootFolderId!.Value"
					 Class="flex-grow-1" Style="height: 100%;" Elevation="0" />
		</MudTabPanel>

		<MudTabPanel Text="Course forum">
			<Forum CourseId="1" Title="Course forum"/>
		</MudTabPanel>

		@if (SelectedSession!.CanManage)
		{
			<MudTabPanel Text="Session settings">
				<SessionSettingsView SessionId="SelectedSession!.Id" OnSessionDeleted="OnSessionDeleted" OnSessionUpdated="OnSessionUpdated"/>
			</MudTabPanel>
		}


	</MudTabs>
}

@code {

	[Parameter]
	public long SelectedSessionId { get; set; }

	[Parameter]
	public long CourseId { get; set; }

	private Session? SelectedSession { get; set; }

	private bool Loading => SelectedSession is null;

	protected override async Task OnParametersSetAsync()
	{
		SelectedSession = await SessionService.GetSessionAsync(SelectedSessionId);
		if (SelectedSession == null)
		{
			NavigationManager.NavigateTo("courses");
			return;
		}

		BreadcrumbsService.Set(
			Icons.Material.Filled.MeetingRoom,
			SelectedSession.Name,
			new BreadcrumbItem("Courses", "courses"),
			new BreadcrumbItem(SelectedSession.CourseName, $"courses/{SelectedSession.CourseId}"),
			new BreadcrumbItem(SelectedSession.Name, null, true)
		);
	}

	private void OnSessionDeleted()
	{
		NavigationManager.NavigateTo($"courses/{SelectedSession!.CourseId}");
	}

	private async void OnSessionUpdated()
	{
		await OnParametersSetAsync();
	}

}